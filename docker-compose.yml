version: "3.9"

services:
  gitea:
    image: gitea/gitea:${GITEA_VERSION}
    container_name: gitea
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - USER_UID=1000
      - USER_GID=1000
      - GITEA__security__INSTALL_LOCK=true
      - GITEA__server__DOMAIN=gitea.localhost
      - GITEA__server__ROOT_URL=${GITEA_PUBLIC_URL}
    volumes:
      - gitea-data:/data
    ports:
      - "${GITEA_HTTP_PORT}:3000"
      - "${GITEA_SSH_PORT}:22"
    extra_hosts:
      - "gitea.localhost:${HOST_GATEWAY_IP:-10.88.0.1}"
      - "woodpecker.localhost:${HOST_GATEWAY_IP:-10.88.0.1}"
      - "argocd.localhost:${HOST_GATEWAY_IP:-10.88.0.1}"
      - "demo.localhost:${HOST_GATEWAY_IP:-10.88.0.1}"
      - "minio.localhost:${HOST_GATEWAY_IP:-10.88.0.1}"
      - "mlflow.localhost:${HOST_GATEWAY_IP:-10.88.0.1}"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3000/api/healthz" ]
      interval: 20s
      timeout: 5s
      retries: 5

  registry:
    image: registry:${REGISTRY_VERSION}
    container_name: registry
    restart: unless-stopped
    ports:
      - "${REGISTRY_HTTP_PORT}:5000"
    volumes:
      - registry-data:/var/lib/registry
    healthcheck:
      test: [ "CMD", "wget", "--spider", "http://localhost:5000/v2/" ]
      interval: 30s
      timeout: 5s
      retries: 5

  woodpecker-server:
    image: woodpeckerci/woodpecker-server:${WOODPECKER_VERSION}
    container_name: woodpecker-server
    restart: unless-stopped
    depends_on:
      - gitea
    env_file:
      - .env
    environment:
      - WOODPECKER_OPEN=true
      - WOODPECKER_HOST=${WOODPECKER_HOST}
      - WOODPECKER_GITEA=true
      - WOODPECKER_GITEA_URL=${WOODPECKER_GITEA_URL}
      - WOODPECKER_GITEA_CLIENT=${WOODPECKER_GITEA_CLIENT}
      - WOODPECKER_GITEA_SECRET=${WOODPECKER_GITEA_SECRET}
      - WOODPECKER_EXPERT_FORGE_OAUTH_HOST=${WOODPECKER_EXPERT_FORGE_OAUTH_HOST}
      - WOODPECKER_EXPERT_WEBHOOK_HOST=${WOODPECKER_EXPERT_WEBHOOK_HOST}
      - WOODPECKER_AGENT_SECRET=${WOODPECKER_AGENT_SECRET}
      - WOODPECKER_ADMIN=${WOODPECKER_ADMIN}
    ports:
      - "${WOODPECKER_SERVER_PORT}:8000"
    extra_hosts:
      - "localhost:${HOST_GATEWAY_IP:-10.88.0.1}"
      - "gitea.localhost:${HOST_GATEWAY_IP:-10.88.0.1}"
      - "woodpecker.localhost:${HOST_GATEWAY_IP:-10.88.0.1}"
      - "argocd.localhost:${HOST_GATEWAY_IP:-10.88.0.1}"
      - "demo.localhost:${HOST_GATEWAY_IP:-10.88.0.1}"
      - "minio.localhost:${HOST_GATEWAY_IP:-10.88.0.1}"
      - "mlflow.localhost:${HOST_GATEWAY_IP:-10.88.0.1}"
    volumes:
      - woodpecker-data:/var/lib/woodpecker

  woodpecker-agent:
    image: woodpeckerci/woodpecker-agent:${WOODPECKER_VERSION}
    container_name: woodpecker-agent
    restart: unless-stopped
    depends_on:
      - woodpecker-server
    env_file:
      - .env
    environment:
      - WOODPECKER_SERVER=woodpecker-server:9000
      - WOODPECKER_AGENT_SECRET=${WOODPECKER_AGENT_SECRET}
      - WOODPECKER_BACKEND=docker
      - WOODPECKER_BACKEND_DOCKER_NETWORK=${COMPOSE_PROJECT_NAME}_default
      - DOCKER_HOST=${PODMAN_DOCKER_HOST}
    volumes:
      - ${DOCKER_SOCKET:-/var/run/docker.sock}:/var/run/docker.sock
    extra_hosts:
      - "gitea.localhost:${HOST_GATEWAY_IP:-10.88.0.1}"
      - "woodpecker.localhost:${HOST_GATEWAY_IP:-10.88.0.1}"
      - "argocd.localhost:${HOST_GATEWAY_IP:-10.88.0.1}"
      - "demo.localhost:${HOST_GATEWAY_IP:-10.88.0.1}"
      - "minio.localhost:${HOST_GATEWAY_IP:-10.88.0.1}"
      - "mlflow.localhost:${HOST_GATEWAY_IP:-10.88.0.1}"

  bootstrap:
    build:
      context: ./bootstrap
    container_name: platform-bootstrap
    depends_on:
      - gitea
      - registry
      - woodpecker-server
    env_file:
      - .env
    volumes:
      - ${DOCKER_SOCKET:-/var/run/docker.sock}:/var/run/docker.sock
      - ./.env:/workspace/.env
      - ./docker-compose.yml:/workspace/docker-compose.yml:ro
      - ./.woodpecker.yml:/workspace/.woodpecker.yml:ro
      - ./gitops:/workspace/gitops
      - ./hello-api:/workspace/hello-api
      - ./ml:/workspace/ml
      - ./scripts:/workspace/scripts:ro
      - ./mlflow:/workspace/mlflow:ro
    environment:
      - BOOTSTRAP_TRACE=true
      - DOCKER_HOST=${PODMAN_DOCKER_HOST:-unix:///var/run/docker.sock}
    entrypoint: [ "/workspace/scripts/bootstrap.sh" ]
    extra_hosts:
      - "registry.localhost:${HOST_GATEWAY_IP:-10.88.0.1}"
    networks:
      - default
      - podman

volumes:
  gitea-data:
  registry-data:
  woodpecker-data:


networks:
  default: {}
  podman:
    external: true
    name: podman

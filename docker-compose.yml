version: "3.9"

services:
  gitea:
    image: gitea/gitea:${GITEA_VERSION}
    container_name: gitea
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - USER_UID=1000
      - USER_GID=1000
      - GITEA__security__INSTALL_LOCK=true
      - GITEA__server__DOMAIN=localhost
      - GITEA__server__ROOT_URL=${GITEA_PUBLIC_URL}
    volumes:
      - gitea-data:/data
    ports:
      - "${GITEA_HTTP_PORT}:3000"
      - "${GITEA_SSH_PORT}:22"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/healthcheck"]
      interval: 20s
      timeout: 5s
      retries: 5

  registry:
    image: registry:${REGISTRY_VERSION}
    container_name: registry
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - "${REGISTRY_HTTP_PORT}:5000"
    volumes:
      - registry-data:/var/lib/registry
    environment:
      REGISTRY_HTTP_HEADERS_Access-Control-Allow-Origin: '*'
      REGISTRY_HTTP_HEADERS_Access-Control-Allow-Methods: 'HEAD,GET,OPTIONS,DELETE'
    healthcheck:
      test: ["CMD", "wget", "--spider", "http://localhost:5000/v2/"]
      interval: 30s
      timeout: 5s
      retries: 5

  woodpecker-server:
    image: woodpeckerci/woodpecker-server:${WOODPECKER_VERSION}
    container_name: woodpecker-server
    restart: unless-stopped
    depends_on:
      - gitea
    env_file:
      - .env
    environment:
      - WOODPECKER_OPEN=true
      - WOODPECKER_HOST=${WOODPECKER_HOST}
      - WOODPECKER_GITEA=true
      - WOODPECKER_GITEA_URL=${GITEA_INTERNAL_URL}
      - WOODPECKER_GITEA_CLIENT=${WOODPECKER_GITEA_CLIENT}
      - WOODPECKER_GITEA_SECRET=${WOODPECKER_GITEA_SECRET}
      - WOODPECKER_AGENT_SECRET=${WOODPECKER_AGENT_SECRET}
      - WOODPECKER_ADMIN=${WOODPECKER_ADMIN}
    ports:
      - "${WOODPECKER_SERVER_PORT}:8000"

  woodpecker-agent:
    image: woodpeckerci/woodpecker-agent:${WOODPECKER_VERSION}
    container_name: woodpecker-agent
    restart: unless-stopped
    depends_on:
      - woodpecker-server
    env_file:
      - .env
    environment:
      - WOODPECKER_SERVER=woodpecker-server:9000
      - WOODPECKER_AGENT_SECRET=${WOODPECKER_AGENT_SECRET}
      - WOODPECKER_BACKEND=docker
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  bootstrap:
    build:
      context: ./bootstrap
    container_name: platform-bootstrap
    depends_on:
      - gitea
      - registry
      - woodpecker-server
    env_file:
      - .env
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./gitops:/workspace/gitops
      - ./scripts:/workspace/scripts:ro
    environment:
      - BOOTSTRAP_TRACE=true
    entrypoint: ["/workspace/scripts/bootstrap.sh"]

volumes:
  gitea-data:
  registry-data:
